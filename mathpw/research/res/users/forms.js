var sortByIndex=function(e,t){var n=e.get("index");var r=t.get("index");return n<r?-1:n>r?1:0};var updateRecords=function(e,t){$.each(t,function(t,n){if(e.length>t){n.update(e[t])}else{n.deleteRecord()}});var n=t.length-e.length;for(var r=0;r<n;r++){t.pop()}if(e.length>t.length){var i=t.length;n=e.length-i;for(var r=-1;r<n;r++){var s=i+r;var o=window.TABLE.insert(e[s]);t.push(o)}}sync()};var sync=function(){toastr.info("Syncing to Dropbox...");var e=setInterval(function(){if(!window.DATASTORE.getSyncStatus()["uploading"]){toastr.success("Sync completed.");clearInterval(e)}},1e3)};var readPromo=function(){var e=$("#promotions > textarea");e=$.map($.makeArray(e),function(e,t){return{type:"promo",index:t,text:$(e).val()}});return e};var readTableRow=function(e){e=$(e);var t={};e.children().each(function(e,n){var r=n.innerHTML;r.replace(/<[^>]*>?/g,"");switch(e){case 0:t.website=r;break;case 1:t.remarks=r;break;case 2:t.price=r;break;case 3:t.quantity=r;break}});return t};var readGiftbox=function(){var e=$.makeArray($("#giftbox tr"));e.shift();e=$.map(e,function(e,t){return $.extend({type:"giftbox",index:t},readTableRow(e))});return e};var promoInit=function(e){var t=$("#promotions > textarea");$.each(e,function(e,n){if(t.length>=e){$(t[e]).val(n.get("text"))}else{$("#promotions > textarea").last().after($("<textarea>").val(n.get("text")))}});promoButtons(e)};var promoButtons=function(e){$("#add_promo").click(function(e){$("#promotions > textarea").last().after("<textarea></textarea>")});$("#rem_promo").click(function(e){if($("#promotions").children("textarea").length>3){$("#promotions > textarea").last().remove()}else{toastr.error("You need to enter at least 3 promotions!")}});$("#promotions").submit(function(t){if(window.DROPBOX_ENABLED&&window.S_ENABLE_SAVE){var n=readPromo();updateRecords(n,e);t.preventDefault()}else{toastr.error("Please export your data on the bottom of the page.","Dropbox not activated");t.preventDefault()}})};var giftboxInit=function(e){var t=$.makeArray($("#giftbox tr"));t.shift();$.each(e,function(e,n){var r='<td contenteditable="true">'+n.get("website").replace(/<[^>]*>?/g,"")+"</td>";var i='<td contenteditable="true">'+n.get("remarks").replace(/<[^>]*>?/g,"")+"</td>";var s='<td contenteditable="true">'+n.get("price").replace(/<[^>]*>?/g,"")+"</td>";var o='<td contenteditable="true">'+n.get("quantity").replace(/<[^>]*>?/g,"")+"</td>";if(t.length>=e){$(t[e]).html(r+i+s+o)}else{var u=$("#giftbox tr").last().after('<tr contenteditable="true">'+r+i+s+o+"</td>")}});giftboxButtons(e)};var giftboxButtons=function(e){$("#add_giftbox").click(function(e){$("#giftbox tr").last().after('<tr contenteditable="true"><td></td><td></td><td></td><td></td></tr>')});$("#rem_giftbox").click(function(e){if($("#giftbox tr").length>6){$("#giftbox tr").last().remove()}else{toastr.error("You need to research at least 5 giftboxes!")}});$("#submit_giftbox").click(function(t){if(window.DROPBOX_ENABLED&&window.S_ENABLE_SAVE){var n=readGiftbox();updateRecords(n,e);t.preventDefault()}else{toastr.error("Please export your data on the bottom of the page.","Dropbox not activated");t.preventDefault()}})};var exportJSON=function(){var e=readPromo();var t=readGiftbox();var n={name:window.NAME,promo:e,giftbox:t};return JSON.stringify(n,undefined,2)};$(document).ready(function(){toastr.options.timeOut=5e3;if(window.DROPBOX_ENABLED){switch(window.S_DB_DELETE_ALL){case false:break;case true:$.each(window.TABLE.query(),function(e,t){t.deleteRecord()});break;case"promo":$.each(window.TABLE.query({type:"promo"}),function(e,t){t.deleteRecord()});break;case"giftbox":$.each(window.TABLE.query({type:"giftbox"}),function(e,t){t.deleteRecord()});break}var e=window.TABLE.query({type:"promo"});e.sort(sortByIndex);promoInit(e);var t=window.TABLE.query({type:"giftbox"});t.sort(sortByIndex);giftboxInit(t);$("#export").click(function(e){$(this).attr("href","data:text/plain;charset=UTF-8,"+encodeURIComponent(exportJSON()))})}else{promoButtons(null);giftboxButtons(null);$("#export").click(function(e){$(this).attr("href","data:text/plain;charset=UTF-8,"+encodeURIComponent(exportJSON()))})}});if(window.DROPBOX_ENABLED){$(window).bind("beforeunload",function(e){if(window.DATASTORE.getSyncStatus()["uploading"]){return"Progress has not been saved! Are you sure you want to leave?"}})}